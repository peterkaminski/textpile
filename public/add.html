<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Add Post · Textpile</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <header>
      <a id="instance-name" class="instance-name" href="/">Textpile</a>
      <div class="actions">
        <a href="/">Home</a>
        <span class="separator" aria-hidden="true">&middot;</span>
        <a href="/about">About</a>
      </div>
    </header>

    <h1>Add Post</h1>

    <p class="small">
      Paste plain text or Markdown.<br>
      No author identity is collected; IP addresses may be logged. Posts expire automatically.<br>
      <a href="/about">Important use notes →</a>
    </p>

    <form id="form" class="row">
      <label>
        Title (optional)
        <input id="title" name="title" maxlength="140" placeholder="e.g. Analysis of recent developments" />
      </label>

      <label>
        Body (required)
        <textarea id="body" name="body" placeholder="Paste Markdown or plain text here" required></textarea>
        <div class="small" id="size-info"></div>
      </label>

      <label>
        Retention period (required)
        <select id="expiry" name="expiry" required>
          <option value="1week">1 week</option>
          <option value="1month">1 month</option>
          <option value="3months">3 months</option>
          <option value="6months">6 months</option>
          <option value="1year">1 year</option>
        </select>
      </label>

      <p class="small">
        <strong>Important:</strong> Posts expire automatically after the selected period. Textpile does not back up content. Keep your own copy!
      </p>

      <div class="actions">
        <button type="submit" id="btn">Publish</button>
        <span id="msg" class="small"></span>
      </div>

      <hr />

      <details>
        <summary class="small">Optional: add post password</summary>
        <p class="small">
          If the site owner has enabled an add post password, paste it here. Otherwise leave blank.
        </p>
        <input id="token" name="token" placeholder="add post password (if required)" />
      </details>
    </form>

    <script type="module">
      import { initPage, getConfig } from '/textpile-utils.js';

      // Initialize page (load config, apply community name, update page title, add footer)
      await initPage({ pageTitle: "Add Post" });

      // Set default retention from config
      const defaultRetention = getConfig('defaultRetention');
      const expirySelect = document.getElementById("expiry");
      if (defaultRetention && expirySelect) {
        const option = expirySelect.querySelector(`option[value="${defaultRetention}"]`);
        if (option) {
          option.selected = true;
        }
      }

      const form = document.getElementById("form");
      const msg = document.getElementById("msg");
      const btn = document.getElementById("btn");
      const bodyField = document.getElementById("body");
      const sizeInfo = document.getElementById("size-info");

      // Size limits (hardcoded to match server defaults)
      const MAX_SIZE = 1048576; // 1 MB
      const WARN_SIZE = 786432; // 750 KB

      function updateSizeInfo() {
        const text = bodyField.value;
        const size = new Blob([text]).size;
        const sizeMB = (size / 1048576).toFixed(2);
        const sizeKB = (size / 1024).toFixed(1);

        if (size > MAX_SIZE) {
          sizeInfo.innerHTML = `<span style="color: #f44336;">⚠️ Too large: ${sizeMB} MB (max 1 MB)</span>`;
          btn.disabled = true;
        } else if (size > WARN_SIZE) {
          sizeInfo.innerHTML = `<span style="color: #ff9800;">⚠️ Warning: ${sizeKB} KB (approaching 1 MB limit)</span>`;
          btn.disabled = false;
        } else {
          sizeInfo.textContent = `Size: ${sizeKB} KB`;
          btn.disabled = false;
        }
      }

      bodyField.addEventListener("input", updateSizeInfo);
      updateSizeInfo();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        msg.textContent = "";
        btn.disabled = true;

        const title = document.getElementById("title").value.trim();
        const body = document.getElementById("body").value.trim();
        const expiry = document.getElementById("expiry").value;
        const token = document.getElementById("token").value.trim();

        // Client-side validation
        if (!body) {
          msg.textContent = "Body is required.";
          btn.disabled = false;
          return;
        }

        try {
          const res = await fetch("/api/add", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({
              title: title || null,
              body,
              expiry,
              token: token || null
            })
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            throw new Error(data?.error || `Add failed: ${res.status}`);
          }

          msg.textContent = "Published. Redirecting…";
          window.location.href = data.url;
        } catch (err) {
          msg.textContent = String(err.message || err);
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
