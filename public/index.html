<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Textpile</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Textpile RSS Feed" href="/feed.xml" />
  </head>
  <body>
    <header>
      <a id="instance-name" class="instance-name" href="/">Textpile</a>
      <div class="actions">
        <a href="/about">About</a>
        <span class="separator" aria-hidden="true">&middot;</span>
        <a href="/add">Add Post</a>
        <span class="separator" aria-hidden="true">&middot;</span>
        <a href="/feed.xml" title="RSS Feed">RSS</a>
      </div>
    </header>

    <h1>Posts</h1>

    <p class="small">
      Long-form posts for <span id="community-name">the community</span>.<br>
      Posts expire automatically; authors keep their own records.<br>
      <a href="/about">Important use notes ‚Üí</a>
    </p>

    <div id="status" class="small">Loading‚Ä¶</div>
    <div id="list"></div>

    <script type="module">
      import { initPage, formatDateTime } from '/textpile-utils.js';

      const status = document.getElementById("status");
      const list = document.getElementById("list");

      function escapeHtml(s) {
        return s.replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
      }

      // Initialize page (load config, apply community name, update page title, add footer)
      await initPage({ pageTitle: "Posts" });

      try {
        const res = await fetch("/api/index", { headers: { "accept": "application/json" }});
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          throw new Error(errorData.message || errorData.error || `Index fetch failed: ${res.status}`);
        }
        const data = await res.json();

        const items = Array.isArray(data.items) ? data.items : [];
        status.textContent = items.length ? `${items.length} posts` : "No posts yet.";

        list.innerHTML = items.map(it => {
          const title = it.title ? escapeHtml(it.title) : "(untitled)";
          const created = it.createdAt ? formatDateTime(it.createdAt) : "";
          const url = it.url ? escapeHtml(it.url) : "#";
          const pinIcon = it.pinned ? 'üìå ' : '';
          return `
            <div class="card">
              <div><a href="${url}">${pinIcon}${title}</a></div>
              <div class="meta">${escapeHtml(created)} ¬∑ ${escapeHtml(it.id)}</div>
            </div>
          `;
        }).join("");
      } catch (err) {
        console.error("Failed to load posts:", err);
        status.textContent = "Failed to load posts.";
        
        // Show helpful error message
        const errorMsg = String(err.message || err);
        if (errorMsg.includes("KV namespace not configured")) {
          list.innerHTML = `
            <div class="card">
              <h2>‚ö†Ô∏è Configuration Required</h2>
              <p><strong>KV namespace is not configured.</strong></p>
              <p>To use Textpile, you need to configure a KV namespace binding in Cloudflare Pages:</p>
              <ol>
                <li>Go to your Cloudflare Pages project</li>
                <li>Navigate to <strong>Settings ‚Üí Functions</strong></li>
                <li>Scroll to <strong>KV namespace bindings</strong></li>
                <li>Add a binding with variable name: <code>KV</code></li>
                <li>Select or create a KV namespace</li>
                <li>Redeploy your site</li>
              </ol>
              <p>See the <a href="https://developers.cloudflare.com/pages/functions/bindings/#kv-namespaces" target="_blank">Cloudflare documentation</a> for more details.</p>
            </div>
          `;
        } else {
          list.innerHTML = `
            <div class="card">
              <h2>Error Loading Posts</h2>
              <p>${escapeHtml(errorMsg)}</p>
              <details>
                <summary>Technical Details</summary>
                <pre>${escapeHtml(String(err?.stack || err))}</pre>
              </details>
            </div>
          `;
        }
      }
    </script>
  </body>
</html>
