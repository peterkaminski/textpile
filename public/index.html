<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Textpile</title>
    <link rel="stylesheet" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Textpile RSS Feed" href="/feed.xml" />
  </head>
  <body>
    <header>
      <a id="instance-name" class="instance-name" href="/">Textpile</a>
      <div class="actions">
        <a href="/about">About</a>
        <span class="separator" aria-hidden="true">&middot;</span>
        <a href="/add">Add Post</a>
        <span class="separator" aria-hidden="true">&middot;</span>
        <a href="/feed.xml" title="RSS Feed">RSS</a>
      </div>
    </header>

    <h1>Posts</h1>

    <p class="small">
      Long-form posts for <span id="community-name">the community</span>.<br>
      Posts expire automatically; authors keep their own records.<br>
      <a href="/about">Important use notes â†’</a>
    </p>

    <div id="status" class="small">Loadingâ€¦</div>
    <div id="list"></div>

    <script type="module">
      import { initPage, formatDateTime } from '/textpile-utils.js';

      const status = document.getElementById("status");
      const list = document.getElementById("list");

      function escapeHtml(s) {
        return s.replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
      }

      // Initialize page (load config, apply community name, update page title, add footer)
      await initPage({ pageTitle: "Posts" });

      try {
        const res = await fetch("/api/index", { headers: { "accept": "application/json" }});
        if (!res.ok) throw new Error(`Index fetch failed: ${res.status}`);
        const data = await res.json();

        const items = Array.isArray(data.items) ? data.items : [];
        status.textContent = items.length ? `${items.length} posts` : "No posts yet.";

        list.innerHTML = items.map(it => {
          const title = it.title ? escapeHtml(it.title) : "(untitled)";
          const created = it.createdAt ? formatDateTime(it.createdAt) : "";
          const url = it.url ? escapeHtml(it.url) : "#";
          const pinIcon = it.pinned ? 'ðŸ“Œ ' : '';
          return `
            <div class="card">
              <div><a href="${url}">${pinIcon}${title}</a></div>
              <div class="meta">${escapeHtml(created)} Â· ${escapeHtml(it.id)}</div>
            </div>
          `;
        }).join("");
      } catch (err) {
        status.textContent = "Failed to load posts.";
        list.innerHTML = `<pre>${String(err?.stack || err)}</pre>`;
      }
    </script>
  </body>
</html>
